
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Géocodage - Documentation pré-processing Panel Lémanique</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#geocodage" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href=".." title="Documentation pré-processing Panel Lémanique" class="md-header__button md-logo" aria-label="Documentation pré-processing Panel Lémanique" data-md-component="logo">
      
  <img src="../images/Logo-Panel.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Documentation pré-processing Panel Lémanique
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Géocodage
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Documentation pré-processing Panel Lémanique" class="md-nav__button md-logo" aria-label="Documentation pré-processing Panel Lémanique" data-md-component="logo">
      
  <img src="../images/Logo-Panel.png" alt="logo">

    </a>
    Documentation pré-processing Panel Lémanique
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Accueil
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../wave1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vague 1 Mobilité I
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../wave3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vague 3 Mobilité II
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../pdcn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vague acceptabilité sociale de mesures d'aménagement du territoire
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../rythme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vague rythmes et temporalités de mobilité
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ete/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vague loisirs été
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hiver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vague loisirs hiver
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contact
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fonction-geocoding" class="md-nav__link">
    <span class="md-ellipsis">
      Fonction geocoding
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fonction-main" class="md-nav__link">
    <span class="md-ellipsis">
      Fonction main
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="geocodage">Géocodage</h1>
<p>Cette page est la documentation du fichier <code>Geocodage.R</code>. Dans les données livrées par FORS pour la vague 3, certaines adresses étaient sous forme de coordonnées géographiques (latitude, longitude), tandis que d'autres étaient sous forme d'adresse postale (e.g. 10 Downing Street, London). Afin d'harmoniser les données dans la vague 3 et avec les autres vagues, ces adresses postales ont été géocodées en coordonnées à l'aide du package <code>tidygeocoder</code>.</p>
<h2 id="fonction-geocoding">Fonction <code>geocoding</code></h2>
<ul>
<li>Description: cette fonction transforme une adresse postale en coordonnées géographique</li>
<li>Input: un string contenant une adresse</li>
<li>Output: un string avec les coordonnées géographiques en format <em>lat,lng</em>.</li>
<li>Détail:</li>
</ul>
<pre><code class="language-r">if (is.na(addr) || addr == &quot;&quot; || addr == &quot;-998.998,-998.998&quot; || is_coordinates(addr)) {
    return(addr)
</code></pre>
<p>Vérifie que le string n'est pas vide, un NA, une valeure équivalente à un NA et est bien une adresse à l'aide de la fonction <a href="../utils/#fonction-is_coordinates"><code>is_coordinates</code></a>.</p>
<pre><code class="language-r">address_df &lt;- data.frame(address = addr, stringsAsFactors = FALSE)
</code></pre>
<p>Transforme l'adresse en dataframe, vu que c'est le format attendu par la fonction <code>geocode</code> du package <code>tidygeocoder</code>.</p>
<pre><code class="language-r">
        res &lt;- geocode(.tbl = address_df, address = address, method = &quot;osm&quot;,
                       lat = latitude, long = longitude, limit = 1, verbose = FALSE)
        Sys.sleep(1)
        res
      },
      error = function(e) {
        message(&quot;Error during geocoding: &quot;, e$message)
        return(NULL)
      }
</code></pre>
<p>La fonction <code>geocode</code> est appliquée sur l'adresse. Une pause d'une seconde est forcée entre chaque requête pour respecter les limites de demande d'OpenStreetMap. Un message d'erreur est généré si nécessaire.</p>
<pre><code class="language-r">if (is.data.frame(result) &amp;&amp; !is.na(result$latitude)) {
      return(paste(result$latitude, result$longitude, sep = &quot;,&quot;))
    } else {
      return(NA_character_)
    }
</code></pre>
<p>Si le résultat est valide, il est formaté sous le format <em>lat,lng</em> est retourné. Autrement, un NA est retourné.</p>
<h2 id="fonction-main">Fonction <code>main</code></h2>
<pre><code class="language-r">raw_data &lt;- &quot;base_ponderee_panel_vague_3_mobilite_clean.sav&quot;
geodata &lt;- &quot;Recodage-adresse.csv&quot;

wave3_data &lt;- haven::read_sav(file.path(folder, raw_data))
existing_coords &lt;- readr::read_tsv(file.path(folder, geodata), show_col_types = FALSE)
</code></pre>
<p>Les données brutes de la vague 3 sont chargées, ainsi certaines données ayant déjà été géocodées au préalable et enregistrées dans le fichier <code>Recodage-adresse.csv</code>.</p>
<pre><code class="language-r">cols_to_process &lt;- c(&quot;W1_q14&quot;, &quot;Q14_regroup&quot;, &quot;Q43&quot;, &quot;Q48&quot;, &quot;W1_q48&quot;,
                       &quot;Q48_regroup&quot;, &quot;Q50&quot;, &quot;W1_q50&quot;, &quot;Q50_regroup&quot;,
                       &quot;Q51&quot;, &quot;W1_q51&quot;, &quot;Q51_regroup&quot;)

geolocalised_columns &lt;- wave3_data %&gt;%
  select(IDNO, all_of(cols_to_process)) %&gt;%
  mutate(across(-IDNO, as.character))
</code></pre>
<p>Les colonnes à géocoder sont sélectionnées et transformées en string.</p>
<pre><code class="language-r">for (col in cols_to_process) {
  geolocalised_columns[[col]] &lt;- sapply(geolocalised_columns[[col]], extract_lat_lng)
  }
</code></pre>
<p>Le formatage des coordonnées géographiques livrées dans la vague 3 par FORS étant spécial, ces données sont reformatées de la forme <em>lat, lng</em> à l'aide de <a href="../utils/#fonction-extract_lat_lng">extract_lat_lng</a>.</p>
<pre><code class="language-r">for (col in cols_to_process) {
  output_file &lt;- file.path(output_folder, paste0(&quot;geocoded_&quot;, col, &quot;.rds&quot;))

  if (file.exists(output_file)) {
    message(&quot;Skipping already processed column: &quot;, col)
    geolocalised_columns[[col]] &lt;- readRDS(output_file)
  } else {
    message(&quot;Geocoding column: &quot;, col)
    geolocalised_columns[[col]] &lt;- map_chr(geolocalised_columns[[col]], geocoding)
    saveRDS(geolocalised_columns[[col]], output_file)
  }
}
</code></pre>
<p>Les données sont ensuite géocodées. Comme le code était long à tourner, il a été lancé en plusieurs fois. C'est pourquoi, dès qu'une colonne était géocodée, elle est enregistrées en tant que .rds. Avant de lancer le géocodage, on vérifie qu'un fichier .rds n'existe pas déjà, afin de ne pas refaire tourner le code inutilement.</p>
<pre><code class="language-r">existing_coords &lt;- existing_coords %&gt;%
    mutate(lat_lng = paste(Q14_R_lat, Q14_R_lng, sep = &quot;,&quot;))

  geolocalised_columns &lt;- geolocalised_columns %&gt;%
    left_join(existing_coords %&gt;% select(IDNO, lat_lng), by = &quot;IDNO&quot;)


  cols &lt;- colnames(geolocalised_columns)
  cols &lt;- cols[cols != &quot;lat_lng&quot;]

  new_order &lt;- c(cols[1], &quot;lat_lng&quot;, cols[-1])
  geolocalised_columns &lt;- geolocalised_columns[, new_order]

  readr::write_csv(geolocalised_columns, file.path(output_folder, &quot;geolocalised_data.csv&quot;))
</code></pre>
<p>Les coordonnées contenue dans le fichier <code>Recodage-adresse.csv</code> sont reformatées avant d'être ajoutées au fichier avec toutes les coordonnées nouvellement obtenues. Enfin, l'ensemble des coordonnées est sauvegardée dans un fichier csv.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>